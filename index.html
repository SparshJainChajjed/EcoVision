<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-Waste Classifier</title>
  <!-- UMD build of InferenceJS (Roboflow) -->
  <script src="https://cdn.jsdelivr.net/npm/inferencejs/dist/inference.umd.js"></script>
  <style>
    body { font-family: sans-serif; text-align:center; padding:2rem; }
    #canvas { max-width:100%; margin-top:1rem; }
    #log    { margin-top:1rem; white-space:pre-wrap; font-size:1.1rem; }

    /* üîÑ Spinner */
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 40px; height: 40px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
      display: none;               /* hidden by default */
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>E-Waste Classifier</h1>
  <p>Upload a photo of old electronics (phones, chargers, batteries‚Ä¶)</p>
  <input type="file" id="upload" accept="image/*">

  <!-- üîÑ Spinner element -->
  <div id="loader" class="loader"></div>

  <canvas id="canvas"></canvas>
  <div id="log">Loading model‚Ä¶</div>

  <script>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const PUBLISHABLE_KEY = "rf_YGton8qZtVV5wJtb2BavtAJJntJ2";
    const MODEL_SLUG      = "ewaste-balanced-dataset";
    const MODEL_VERSION   = "2";

    const log    = document.getElementById("log");
    const loader = document.getElementById("loader");

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Helper functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const showLoader = () => loader.style.display = "block";
    const hideLoader = () => loader.style.display = "none";

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Main code ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const engine = new InferenceEngine();
    showLoader();                       // spinner while model downloads

    engine.startWorker(
      MODEL_SLUG,
      MODEL_VERSION,
      PUBLISHABLE_KEY,
      { scoreThreshold: 0.5, iouThreshold: 0.3, maxNumBoxes: 20 }
    ).then(workerId => {
      hideLoader();
      log.textContent = "Model loaded ‚Äî upload an image!";

      document.getElementById("upload").onchange = async evt => {
        const file = evt.target.files[0];
        if (!file) return;

        /* Draw uploaded image */
        const img = new Image();
        img.src = URL.createObjectURL(file);
        await img.decode();
        const canvas = document.getElementById("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        /* Run detection */
        log.textContent = "Detecting‚Ä¶";
        showLoader();

        const preds = await engine.infer(workerId, img);

        hideLoader();
        ctx.strokeStyle = "#00CC00";
        ctx.lineWidth   = 2;
        ctx.font        = "18px sans-serif";
        ctx.fillStyle   = "#00CC00";

        let output = "";
        if (preds.length === 0) {
          output = "No e-waste items detected.";
        } else {
          preds.forEach(p => {
            const [x, y, w, h] = p.bbox;
            ctx.beginPath();
            ctx.rect(x, y, w, h);
            ctx.stroke();
            const label = `${p.class} ${(p.score*100).toFixed(1)}%`;
            ctx.fillText(label, x, y > 20 ? y - 5 : y + 20);
            output += label + "\n";
          });
        }
        log.textContent = output;
      };
    }).catch(err => {
      hideLoader();
      console.error(err);
      log.textContent = "‚ö†Ô∏è Failed to load model.";
    });
  </script>
</body>
</html>
